<!--
Having paypal in the view is causing problem for ActiveMerchant.

The form uses payment_service_for and that is a helper function from ActiveMerchant. Ideally when paypal is selected then
ActiveMerchant::Billing::Base.mode = record.mode.to_sym should be executed.

In the current scenario that code is being executed when view is being rendered. That is not good. What if there is another payment service which
needs to have mode setup as something else.

There is also the issue that order should record that paypal has been selected before forwarding the  request. That can be done much easily if 
things are handled on the server side.

-->
<% order = Order.find_by_id(session[:order_id])
  record = NimbleshopPaypalwp::Paypalwp.first
  ActiveMerchant::Billing::Base.mode = record.mode.to_sym
%>
<%= payment_service_for order.id, NimbleshopPaypalwp::Paypalwp.first.merchant_email,
                             :amount => order.total_amount.round(2),
                             :service => :paypal,
                             :html => { :id => 'paypal-payment-form' } do |service| %>

 <% update_service_with_attributes(service, order) %>

  <!-- Display the payment button. --> 
  <!-- 
  <input type="image" src="https://www.paypal.com/en_US/i/btn/btn_paynowCC_LG.gif" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">
  -->
<% end %>

<label class='radio'>
  <%= radio_button_tag 'payment_choice', 'paypal' %>
  <%= image_tag('paypal.png') %>
</label>

<%= javascript_tag do %>
  $(function() {
    $("input#payment_choice_paypal:radio").change(function() {
      var $this, val;
      $this = $(this);
      val = $this.val();

      if (val === "paypal") {
        $("form#paypal-payment-form").submit();
      }

    });
  });
<% end %>
